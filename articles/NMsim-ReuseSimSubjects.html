<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Reuse simulated subjects • NMsim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Reuse simulated subjects">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.3.922</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/NMsim-basics.html">Simulation of New Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-VPC.html">Simulations for VPCs</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-config.html">Requirements and Configuration</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-known.html">Simulate Known Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-TypSubj.html">Simulate Typical Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulations with Parameter Uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-DataCreate.html">Creation of Simulation Data Sets</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ResidVar.html">Simulation with Residual Variability</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-varyPars.html">Varying Parameter Values</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse Simulated Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-speed.html">Debugging, Speed, and Disk Space</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Reuse simulated subjects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/philipdelff/NMsim/blob/main/vignettes/NMsim-ReuseSimSubjects.Rmd" class="external-link"><code>vignettes/NMsim-ReuseSimSubjects.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-ReuseSimSubjects.Rmd</code></div>
    </div>

    
    
<p>Simulating new subjects is a very common task, and this is even the
default simulation method in <code>NMsim</code> (because Nonmem does
that with in a <code>$SIMULATION</code> step). However, sometimes one
may want to perform multiple simulations using the same
<em>simulated</em> subjects. So we want to simulate new subjects, but
only once, and then we want to be able to reuse those subjects. This can
be wanted for at least these reasons:</p>
<ul>
<li><p>Compare simulations of different scenarios with multiple subjects
where ensuring that the difference in results isn’t caused by
differences in simulated subjects (less important the more subjects that
are used in the simulations)</p></li>
<li><p>Ensure reproducibility of results. If the simulation input data
is modified by say adding a simulation scenario in between two existing
ones - or even just a sample time, the random number generator will be
in different state when sampling the subjects the next time it runs.
Suddenly, an estimated prediction interval comes out a little
different.</p></li>
</ul>
<p><code>NMsim</code> has a way to do this. It includes a function,
<code><a href="../reference/simPopEtas.html">simPopEtas()</a></code>, to generate a simulated <code>.phi</code>
file which is a Nonmem-native format for storing emperical Bayes
estimates (essentially individual parameters). It does so by reading and
simulating from the estimated <code>OMEGA</code> matrix (random-effect
variance-covariance matrix - a covariance step is not needed to get
this). The simulation method called <code><a href="../reference/NMsim_known.html">NMsim_known()</a></code> can then
be used to simulate subjects as stored in this file. See <a href="https://philipdelff.github.io/NMsim/articles/NMsim-known.html"><code>NMsim-known.html</code></a>
for more information on <code>NMsim_known</code>.</p>
<div class="section level3">
<h3 id="what-is-a-subject">What is a subject?<a class="anchor" aria-label="anchor" href="#what-is-a-subject"></a>
</h3>
<p>What is refered to here by “subject” is really a combination of
<code>ETA</code>s. Covariates must be handled by the user in the
simulation input dataset. This is also discussed in <a href="https://philipdelff.github.io/NMsim/articles/NMsim-known.html"><code>NMsim-known.html</code></a>.</p>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.project</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples"</span>,package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span>,<span class="va">...</span><span class="op">)</span></span>
<span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu">file.project</span><span class="op">(</span><span class="st">"nonmem/xgxr032.mod"</span><span class="op">)</span></span></code></pre></div>
<p>Let’s simulate 10,000 ETA combinations and store them in a file
called <code>xgxr032_simEtas.phi</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">NMsim</span><span class="fu">:::</span><span class="fu"><a href="../reference/simPopEtas.html">simPopEtas</a></span><span class="op">(</span>file<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                   N<span class="op">=</span><span class="fl">1e4</span>,</span>
<span>                   seed<span class="op">=</span><span class="fl">238861</span>,</span>
<span>                   file.phi<span class="op">=</span><span class="st">"xgxr032_simEtas.phi"</span></span>
<span>                   <span class="op">)</span></span></code></pre></div>
<p>We’ll just use the simulation data set created in <a href="https://philipdelff.github.io/NMsim/articles/NMsim-DataCreate.html"><code>NMsim-DataCreate.html</code></a></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.sim</span> <span class="op">&lt;-</span> <span class="fu">read_fst</span><span class="op">(</span>path<span class="op">=</span><span class="st">"simulate-results/dat_sim.fst"</span>,as.data.table<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>And now we can use <code><a href="../reference/NMsim_known.html">NMsim_known()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.sim.multiple</span> <span class="op">&lt;-</span> <span class="fu">egdt</span><span class="op">(</span><span class="va">dat.sim</span><span class="op">[</span>,<span class="op">!</span><span class="op">(</span><span class="st">"ID"</span><span class="op">)</span><span class="op">]</span>,<span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ID<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">89</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      data nrows ncols</span></span>
<span><span class="co">#&gt;    &lt;char&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:    dt1   171    10</span></span>
<span><span class="co">#&gt; 2:    dt2     3     1</span></span>
<span><span class="co">#&gt; 3: result   513    11</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dat.sim.multiple</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span></span>
<span>    file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>    data<span class="op">=</span><span class="va">dat.sim.multiple</span>,</span>
<span>    method.sim<span class="op">=</span><span class="va">NMsim_known</span>,</span>
<span>    file.phi<span class="op">=</span><span class="st">"xgxr032_simEtas.phi"</span>,</span>
<span>    name.sim<span class="op">=</span><span class="st">"reuseSubjs"</span>,</span>
<span>    table.vars<span class="op">=</span><span class="st">"PRED IPRED"</span>,</span>
<span>    path.nonmem<span class="op">=</span><span class="st">"/opt/NONMEM/nm75/run/nmfe75"</span>,</span>
<span>    dir.sims<span class="op">=</span><span class="st">"simulate-tmp"</span>,</span>
<span>    dir.res<span class="op">=</span><span class="st">"simulate-results"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="simulate-the-same-simulated-subjects-on-multiple-regimens">Simulate the same simulated subjects on multiple regimens<a class="anchor" aria-label="anchor" href="#simulate-the-same-simulated-subjects-on-multiple-regimens"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.sim.multiple.regs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">300</span>,<span class="fl">600</span><span class="op">)</span>,<span class="kw">function</span><span class="op">(</span><span class="va">dose1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">dat.sim.multiple</span>,AMT<span class="op">=</span><span class="va">AMT</span><span class="op">/</span><span class="fl">300</span><span class="op">*</span><span class="va">dose1</span>,trt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%d mg then %d mg QD"</span>,<span class="va">dose1</span>,<span class="va">dose1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">dat.sim.multiple.regs</span><span class="op">[</span>,<span class="va">REC</span><span class="op">:=</span><span class="va">.I</span><span class="op">]</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="note-on-between-occasion-variability-supported">Note on between-occasion variability (supported)<a class="anchor" aria-label="anchor" href="#note-on-between-occasion-variability-supported"></a>
</h2>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>



  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
