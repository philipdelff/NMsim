<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="NMsim">
<title>VPC simulations • NMsim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="VPC simulations">
<meta property="og:description" content="NMsim">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.911</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-vignettes">Vignettes</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-vignettes">
    <a class="dropdown-item" href="../articles/NMsim-basics.html">Simulation of new subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-VPC.html">Simulations for VPCs</a>
    <a class="dropdown-item" href="../articles/NMsim-config.html">NMsim Configuration</a>
    <a class="dropdown-item" href="../articles/NMsim-known.html">Simulate known subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-TypSubj.html">Simulate typical subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulations with parameter uncertainty</a>
    <a class="dropdown-item" href="../articles/NMsim-DataCreate.html">Creation of Simulation Data Sets</a>
    <a class="dropdown-item" href="../articles/NMsim-ResidVar.html">Simulation with residual variability</a>
    <a class="dropdown-item" href="../articles/NMsim-varyPars.html">Varying parameter values</a>
    <a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse simulated subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-speed.html">Debugging, Speed, and Disk Space</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>VPC simulations</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/philipdelff/NMsim/blob/HEAD/vignettes/NMsim-VPC.Rmd" class="external-link"><code>vignettes/NMsim-VPC.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-VPC.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="simulations-for-visual-predictive-checks-vpc">Simulations for Visual Predictive Checks (VPC)<a class="anchor" aria-label="anchor" href="#simulations-for-visual-predictive-checks-vpc"></a>
</h2>
<p>This vignette shows how to generate simulations for generation of VPC
plots. While <code>NMsim</code> does not include any functionality for
summarizing quantiles or plotting, it provides powerful ways to obtain
the simulated data needed. We shall see how the <code>tidyvpc</code>
package easily creates VPC plots based on the simulation results.</p>
</div>
<div class="section level2">
<h2 id="default-option-reuse-estimation-data-for-simulation">Default option: reuse estimation data for simulation<a class="anchor" aria-label="anchor" href="#default-option-reuse-estimation-data-for-simulation"></a>
</h2>
<p>Normally, the two main arguments to NMsim are the path to the input
control stream (<code>file.mod</code>) and the simulation input data set
(<code>data</code>). But if we leave out the the <code>data</code>
argument, NMsim will re-use the estimation data for the simulation. That
is the simulation we need for a VPC. We will use an example model
included with NMsim:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.project</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples"</span>,package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span>,<span class="va">...</span><span class="op">)</span></span>
<span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu">file.project</span><span class="op">(</span><span class="st">"nonmem/xgxr032.mod"</span><span class="op">)</span></span>
<span><span class="fu">NMdataConf</span><span class="op">(</span>path.nonmem<span class="op">=</span><span class="st">"/opt/NONMEM/nm75/run/nmfe75"</span><span class="op">)</span></span>
<span><span class="fu">NMdataConf</span><span class="op">(</span>dir.sims<span class="op">=</span><span class="st">"~/NMsim_vignette"</span>,</span>
<span>           dir.res<span class="op">=</span><span class="st">"simulate-results"</span>,</span>
<span>           allow.unknown<span class="op">=</span><span class="cn">TRUE</span> <span class="co">## necessary for dir.sims and dir.res</span></span>
<span>           <span class="co">## until NMdata 0.1.5</span></span>
<span>           <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">43</span><span class="op">)</span></span>
<span><span class="co">## notice the data argument is not used.</span></span>
<span><span class="va">simres.vpc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span>,</span>
<span>                    table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span>, <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>                    name.sim<span class="op">=</span><span class="st">"vpc_01"</span></span>
<span>                   ,subproblems<span class="op">=</span><span class="fl">500</span></span>
<span>                   ,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span></code></pre></div>
<p>The performed simulation is similar to the one produced by the
<code>VPC</code> function in <code>PSN</code>. However, there are some
important differences.</p>
<ul>
<li><p>The simulation results are automatically read into R.</p></li>
<li><p>The <code>table.vars</code> argument allows the user to narrow
down the variables to be written to disk. This can speed up the
simulation considerably and reduce the amount of disk space the Nonmem
simulation results require.</p></li>
<li><p>No postprocessing of the results is being done by
<code>NMsim</code>. See below how to easily do that.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="plotting-using-tidyvpc">Plotting using <code>tidyvpc</code><a class="anchor" aria-label="anchor" href="#plotting-using-tidyvpc"></a>
</h2>
<p>As mentioned, <code>NMsim</code> does not postprocess the simulation
for generation of a VPC plot, nor does it offter any plotting functions.
The R package called <code>tidyvpc</code> offer those two things and is
moreover implemented in <code>data.table</code>, so it’s fast. The
following simple code shows how to get from the results from
<code>NMsim</code> to the VPC plot with <code>tidyvpc</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/certara/tidyvpc" class="external-link">tidyvpc</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; tidyvpc is part of Certara.R!</span></span>
<span><span class="co">#&gt; Follow the link below to learn more about PMx R package development at Certara.</span></span>
<span><span class="co">#&gt; https://certara.github.io/R-Certara/</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://philipdelff.github.io/NMdata/" class="external-link">NMdata</a></span><span class="op">)</span></span>
<span><span class="co">## read the data as it was used in the Nonmem model</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://philipdelff.github.io/NMdata/reference/NMscanData.html" class="external-link">NMscanData</a></span><span class="op">(</span><span class="va">file.mod</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span>,quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## only plot observation events from estimation data set</span></span>
<span><span class="va">data.obs</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span></span>
<span><span class="co">## Only plot simulated observation events</span></span>
<span><span class="va">data.sim</span> <span class="op">&lt;-</span> <span class="va">simres.vpc</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## run vpc</span></span>
<span><span class="va">vpc1</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidyvpc/man/observed.html" class="external-link">observed</a></span><span class="op">(</span><span class="va">data.obs</span>, x <span class="op">=</span> <span class="va">TIME</span>, y <span class="op">=</span> <span class="va">DV</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidyvpc/man/simulated.html" class="external-link">simulated</a></span><span class="op">(</span><span class="va">data.sim</span>, y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidyvpc/man/stratify.html" class="external-link">stratify</a></span><span class="op">(</span><span class="op">~</span><span class="va">DOSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidyvpc/man/binning.html" class="external-link">binning</a></span><span class="op">(</span>bin <span class="op">=</span> <span class="st">"ntile"</span>, nbins <span class="op">=</span> <span class="fl">9</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidyvpc/man/vpcstats.html" class="external-link">vpcstats</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vpc1</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-VPC_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<div class="section level3">
<h3 id="use-a-different-input-data-set">Use a different input data set<a class="anchor" aria-label="anchor" href="#use-a-different-input-data-set"></a>
</h3>
<p>In the first example we used the exact same data as was used for the
estimation. This is a common way to produce a VPC, and we saw the
advantage that the user does not risk making mistakes in preparing the
data set for the simulations. However, it may be of interest to include
additional data or even a different data set in the simulation. It could
be including data points that were excluded in estimation (like samples
below the quantification limit) or a separate study that was not
included in the model. All you have to do is to read the data you want
and provide it in <code>NMsim</code>’s <code>data</code> argument.</p>
</div>
<div class="section level3">
<h3 id="make-use-of-the-cluster">Make use of the cluster<a class="anchor" aria-label="anchor" href="#make-use-of-the-cluster"></a>
</h3>
<p>We will repeat the same as above, but now 500 times
(<code>subproblems</code>). We make use of a few more arguments for
efficiency. <code>sge</code> means that the jobs will be sent to the
cluster. The <code>nc</code> argument is now used meaning only one core
will be used per job. If each node on the cluster has 16 cores, this
could engage 500/16 ~ 32 nodes in parallel, with all jobs executed at
the same time. We supply the path to the Nonmem executable. With PSN
this should work without specifying the Nonmem path, but PSN for some
reason takes more time submitting the jobs to the cluster. If nodes are
available, the following simulation should not take more than a couple
of minutes to execute.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.res</span> <span class="op">&lt;-</span> <span class="st">"simulate-results/simpaths-vpc.rds"</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">43</span><span class="op">)</span></span>
<span><span class="co">## notice the data argument is not used.</span></span>
<span><span class="va">sim.vpc.sge</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span>,</span>
<span>                     table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span>, <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>                     name.sim<span class="op">=</span><span class="st">"vpc_01"</span></span>
<span>                    ,subproblems<span class="op">=</span><span class="fl">500</span></span>
<span>                    ,sge<span class="op">=</span><span class="cn">TRUE</span></span>
<span>                     <span class="co">## ,path.nonmem="/opt/nonmem/nm751/run/nmfe75"</span></span>
<span>                     <span class="co">##,path.nonmem="/opt/NONMEM/nm75/run/nmfe75"</span></span>
<span>                     <span class="co">##,file.res=file.res</span></span>
<span>                     <span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
