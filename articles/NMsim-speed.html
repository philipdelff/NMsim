<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>NMsim and speed â€¢ NMsim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="NMsim and speed">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.3.907</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/NMsim-basics.html">Simulation of New Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-VPC.html">Simulations for VPCs</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-config.html">Requirements and Configuration</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-known.html">Simulate Known Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-TypSubj.html">Simulate Typical Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulations with Parameter Uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-DataCreate.html">Creation of Simulation Data Sets</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ResidVar.html">Simulation with Residual Variability</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-varyPars.html">Varying Parameter Values</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse Simulated Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-speed.html">Debugging, Speed, and Disk Space</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>NMsim and speed</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/philipdelff/NMsim/blob/main/vignettes/NMsim-speed.Rmd" class="external-link"><code>vignettes/NMsim-speed.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-speed.Rmd</code></div>
    </div>

    
    
<p>The following points show ways to improve calculation speed with
<code>NMsim</code>. The list is somewhat prioritized, most important
first.</p>
<ul>
<li><p>Reduce amount of data written to file Almost always use the
<code>table.vars</code> argument. See the example below too.</p></li>
<li><p>Break the simulation into multiple Nonmem runs</p></li>
<li><p>Use <code>data.table</code> Depending on the data sets this can
make a very large difference. Consider using
<code>NMdataConf(as.fun="data.tabe")</code></p></li>
<li><p>Use <code>method.execute="nmsim"</code></p></li>
<li><p>Parellilize individual runs NMsim does support parellilization
(performing a Nonmem run using multiple cores). However, this is rarely
worth it for simulations. Most of the time, input/output
(reading/writing to disk) is the bottleneck, and splitting the data set
into multiple runs will most often reduce run times more.</p></li>
</ul>
<div class="section level2">
<h2 id="most-common-reasons-for-nmsim-to-fail-or-be-slow">Most common reasons for <code>NMsim</code> to fail or be slow<a class="anchor" aria-label="anchor" href="#most-common-reasons-for-nmsim-to-fail-or-be-slow"></a>
</h2>
<p>If <code>NMsim</code> can find the Nonmem executable and/or PSN, it
should work on basically any models where where it makes sense to
replace the <code>$ESTIMATION</code> by a <code>$SIMULATION</code>. If
<code>NMsim</code> fails or behaves unexpectedly, make sure to read the
output from Nonmem in the R console. If <code>NMsim</code> complains it
cannot find the output tables, it is likely because Nonmem failed and
did not generate them.</p>
<p>There is one thing about the Nonmem model evaluation you have to
remember. Nonmem cannot run a model if it uses variables that are
unavailable. It may be a covariate in the model that you did not include
in your data set. And often the estimation models include variables in
output tables that were not used for anything else by Nonmem than being
read from the input data set and printed in output tables. In fact, this
was exactly why we included a row identifier calle <code>ROW</code> when
generating the simulation data set. If we do not do that, we get this
error:</p>
<pre><code>Starting NMTRAN
 
 AN ERROR WAS FOUND IN THE CONTROL STATEMENTS.
 
AN ERROR WAS FOUND ON LINE 60 AT THE APPROXIMATE POSITION NOTED:
 $TABLE ROW TVKA TVV2 TVV3 TVCL KA V2 V3 CL Q PRED IPRED Y NOPRINT FILE=NMsim_xgxr021_noname.tab
         X  
 THE CHARACTERS IN ERROR ARE: ROW
  479  THIS ITEM IS NOT LISTED IN MODULE NMPRD4 AND MAY NOT BE DISPLAYED.
cp: cannot stat 'NMsim_xgxr021_noname.tab': No such file or directory
Error in NMscanTables(file, quiet = TRUE, as.fun = "data.table", col.row = col.row,  : 
  NMscanTables: File not found: /home/philip/R/x86_64-pc-linux-gnu-library/4.2/NMsim/examples/nonmem/NMsim/xgxr021_noname/NMsim_xgxr021_noname.tab. Did you copy the lst file but forgot table file?
Results could not be read.</code></pre>
<p>Nonmem gets to writing the <code>$TABLE</code> but cannot find a
variable called <code>ROW</code>. Again, we fixed that by including
<code>ROW</code>. In many cases, the best way to fix this is to reduce
the <code>$TABLE</code> section using the <code>table.vars</code>
argument. All we need from the simulation results are population and
individual predictions anyway. We could have omitted <code>ROW</code> in
the input data set and done something as simple as</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                data<span class="op">=</span><span class="va">dat.sim</span>,</span>
<span>                table.vars<span class="op">=</span><span class="st">"PRED IPRED Y"</span><span class="op">)</span></span></code></pre></div>
<p><code>table.vars</code> can help avoid many of these problems. And if
<code>NMsim</code> is slow, this is a potentially a very large
low-hanging fruit. In a benchmark example, I reduced a (very large)
simulation run time from ~1.5 hours to ~7 minutes this way.</p>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>



  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
