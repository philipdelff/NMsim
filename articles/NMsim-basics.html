<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulation of New Subjects • NMsim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulation of New Subjects">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/NMsim-basics.html">Simulation of New Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-VPC.html">Simulations for VPCs</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-config.html">Requirements and Configuration</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-known.html">Simulate Known Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-TypSubj.html">Simulate Typical Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulations with Parameter Uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-DataCreate.html">Creation of Simulation Data Sets</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ResidVar.html">Simulation with Residual Variability</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-varyPars.html">Varying Parameter Values</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse Simulated Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-speed.html">Debugging, Speed, and Disk Space</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simulation of New Subjects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/philipdelff/NMsim/blob/main/vignettes/NMsim-basics.Rmd" class="external-link"><code>vignettes/NMsim-basics.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-basics.Rmd</code></div>
    </div>

    
    
<p>Built 2024-08-24 using NMsim 0.1.3.</p>
<div class="section level2">
<h2 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h2>
<p>This vignettes aims at enabling you to</p>
<ul>
<li><p>Use <code>NMsim</code> to simulate Nonmem models with a given
input data set</p></li>
<li><p>Distinguish between and perform the most common types of
simulations:</p></li>
<li><p>new subjects,</p></li>
<li><p>Simulate multiple new subjects and derive prediction
intervals</p></li>
<li><p>Simulate more than one Nonmem model in one <code><a href="../reference/NMsim.html">NMsim()</a></code>
function call</p></li>
<li><p>Important arguments</p></li>
<li><p>Speed up NMsim by avoiding large table statements</p></li>
<li><p>Add residual variability to an already performed model simulation
using <code>NMsim</code>.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>You should have configured <code>NMsim</code> with the path to the
Nonmem installation and maybe also PSN. See <a href="https://philipdelff.github.io/NMsim/articles/NMsim-config.html"><code>NMsim-config.html</code></a>.
Don’t worry - it is very easy.</p>
</div>
<div class="section level2">
<h2 id="estimation-based-on-single-dose-simulation-of-multiple-doses">Estimation based on single dose, simulation of multiple doses<a class="anchor" aria-label="anchor" href="#estimation-based-on-single-dose-simulation-of-multiple-doses"></a>
</h2>
<p>The situation is like this: We collected PK and PD data from a single
ascending dose trial on a drug candidate. A PK model was estimated using
Nonmem. We have on file the model input and output control streams (here
with extensions <code>.mod</code> and <code>.lst</code> respetively),
parameter estimates (<code>.ext</code>).
<!-- The following plot shows the data for no other reason than pointing out clearly that the data informing the model was single dose, and we will be simulating a different dosing regimen. --></p>
<p>We want to predict concentrations in a multiple dose regimen. This is
a regimen that we have not studied in clinical trials so far, and we
have decided to use population PK simulations for this purpose.</p>
<div class="section level3">
<h3 id="the-simulation-data-set">The Simulation data set<a class="anchor" aria-label="anchor" href="#the-simulation-data-set"></a>
</h3>
<p>You can create a Nonmem-compatible simulation data set however you
want. We will keep that as a separate topic and read one that was
already created in <a href="https://philipdelff.github.io/NMsim/articles/NMsim-DataCreate.html"><code>NMsim-DataCreate.html</code></a>
using tools provided with NMsim to make that task simpler and faster to
do:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/derived/dat_sim1.csv"</span>,package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="simulation-of-a-new-subject">Simulation of a new subject<a class="anchor" aria-label="anchor" href="#simulation-of-a-new-subject"></a>
</h2>
<p>This is the first time we are using <code>NMsim</code>, and we just
want to try the simplest thing we can think of. Simulate a new subject
on the considerd multiple dose regimen with our estimated PK model from
the single dose study.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr021.mod"</span>,package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                data<span class="op">=</span><span class="va">dat.sim</span><span class="op">)</span></span></code></pre></div>
<p>We plot population and individual predictions as the simulations of
(in this case) the typical subject and one simulated subject. The
variable called <code>Y</code> is the individual prediction plus
residual variability. paper. The code is included to show that the
results from <code>NMsim</code> are ready to be plotted. The main reason
data is transformed to long format (<code>melt</code>) is to get ggplot2
to generate the legend automatically.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">datl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span>measure.vars<span class="op">=</span><span class="fu">cc</span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span>,<span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">datl</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">value</span>,colour<span class="op">=</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">[</span><span class="va">variable</span><span class="op">!=</span><span class="st">"Y"</span><span class="op">]</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">[</span><span class="va">variable</span><span class="op">==</span><span class="st">"Y"</span><span class="op">]</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Hours since first dose"</span>,y<span class="op">=</span><span class="st">"Concentration (ng/mL)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-basics_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<p>The reason we can plot a simulation with residual variability is that
the control stream includes a variable <code>Y</code> defined with
residual variability in <code>$ERROR</code>:</p>
<pre><code><span>  <span class="va">Y</span><span class="op">=</span><span class="cn">F</span><span class="op">+</span><span class="cn">F</span><span class="op">*</span><span class="fu">ERR</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span><span class="fu">ERR</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre>
<p>More on residual variability in case you don’t have such a line later
in this paper.</p>
</div>
<div class="section level2">
<h2 id="what-happened">What happened?<a class="anchor" aria-label="anchor" href="#what-happened"></a>
</h2>
<p><code>NMsim</code> uses automation tools from <code>NMdata</code>
to</p>
<ul>
<li>Save the data in a Nonmem-friendly format</li>
<li>Create a simulation control stream based on the referenced input
control stream</li>
<li>Update the initial values based with estimated values</li>
<li>Modify input data-related sections for reading input siulation
data</li>
<li>Modify output table file names and paths to generate simulation
output tables</li>
<li>Run Nonmem</li>
<li>Read output tables and combine them with input data into one data
object</li>
</ul>
<p>The generated files have all been stored in a folder called
<code>NMsim</code> next to the estimation control stream. More on that
shortly in the section “A few basic additional arguments to
<code>NMsim</code>”.</p>
<p>Let’s see the first few lines of the returned object:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt;      ROW    ID  TIME  EVID   CMT   AMT    II  ADDL    DV   MDV   TVKA   TVV2</span></span>
<span><span class="co">#&gt;    &lt;num&gt; &lt;int&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     1     1     0     1     1   300     0     0     0     1 2.1666 75.729</span></span>
<span><span class="co">#&gt; 2:     2     1     0     2     2    NA    NA    NA     0     1 2.1666 75.729</span></span>
<span><span class="co">#&gt; 3:     3     1     1     2     2    NA    NA    NA     0     1 2.1666 75.729</span></span>
<span><span class="co">#&gt;      TVV3   TVCL     KA     V2     V3     CL      Q  IPRED      Y   PRED   RES</span></span>
<span><span class="co">#&gt;     &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 150.06 13.978 2.1666 63.464 150.06 17.944 8.4865 0.0000 0.0000 0.0000     0</span></span>
<span><span class="co">#&gt; 2: 150.06 13.978 2.1666 63.464 150.06 17.944 8.4865 0.0000 0.0000 0.0000     0</span></span>
<span><span class="co">#&gt; 3: 150.06 13.978 2.1666 63.464 150.06 17.944 8.4865 3.1946 3.0486 2.8907     0</span></span>
<span><span class="co">#&gt;     WRES                   trt                model  nmout</span></span>
<span><span class="co">#&gt;    &lt;num&gt;                &lt;char&gt;               &lt;char&gt; &lt;lgcl&gt;</span></span>
<span><span class="co">#&gt; 1:     0 300 mg then 150 mg QD NMsim_xgxr021_noname   TRUE</span></span>
<span><span class="co">#&gt; 2:     0 300 mg then 150 mg QD NMsim_xgxr021_noname   TRUE</span></span>
<span><span class="co">#&gt; 3:     0 300 mg then 150 mg QD NMsim_xgxr021_noname   TRUE</span></span></code></pre></div>
<p>Notice a few things about the returned data:</p>
<ul>
<li>All columns from the output tables defined in the input control
stream are there. We will soon learn how to modify this</li>
<li>Input data columns are there too (like <code>trt</code>).</li>
<li>Additional columns (<code>model</code> and <code>nmout</code>) may
be familiar to <code>NMdata</code> users.</li>
<li>We will soon learn where the “_noname” in the <code>model</code>
column comes from.</li>
</ul>
</div>
<div class="section level2">
<h2 id="how-to-re-read-the-simulation-results">How to (re-)read the simulation results<a class="anchor" aria-label="anchor" href="#how-to-re-read-the-simulation-results"></a>
</h2>
<p><code><a href="../reference/NMsim.html">NMsim()</a></code> creates an <code>.rds</code> file with
information about where all the results are stored. It is named based on
the model name and the <code>name.sim</code> argument. NMsim provides
the path to it in the console at every run. You can also specify exactly
where it should be stored and the file name using the
<code>file.res</code> argument. Run the function <code>NMreadSim</code>
on this file to (re-)read all the simulation results.</p>
<p><code>NMreadSim</code> also supports the <code>wait</code> argument
making it wait for all the simulation results to be available in case
you submitted a large simulation to a cluster and want to continue your
execution only when it’s all done.</p>
</div>
<div class="section level2">
<h2 id="multiple-models">Multiple models<a class="anchor" aria-label="anchor" href="#multiple-models"></a>
</h2>
<p>Before we continue with that model, we want to compare a simulation
based on this model to another model we are considering.
<code>NMsim</code> can do this and collect the data into one object:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">files.2.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr021.mod"</span>,<span class="st">"examples/nonmem/xgxr114.mod"</span><span class="op">)</span>,package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span></span>
<span><span class="va">simres.2models</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">files.2.mod</span>,</span>
<span>                        data<span class="op">=</span><span class="va">dat.sim</span>,</span>
<span>                        file.res<span class="op">=</span><span class="st">"simulate-results/simres_2models_paths.rds"</span></span>
<span>                        <span class="op">)</span></span></code></pre></div>
<p>We included the <code>file.res</code> argument to specify one single
<code>rds</code> file because if not NMsim would create one for each of
the two models simulated. We can re-read the results like this:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.2models</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="st">"simulate-results/simres_2models_paths.rds"</span><span class="op">)</span></span></code></pre></div>
<p>In case multiple models are provided, <code>NMsim</code> simply loops
over them. It does collect all the results, and we can use the
<code>model</code> column to separate the two simulations. Since we are
so far just simulating on subject with each model, it makes litlle sense
to compare individual preditions. We just plot the population prediction
(<code>PRED</code>):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">simres.2models</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">PRED</span>,colour<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trt"</span><span class="op">)</span>,scales<span class="op">=</span><span class="st">"free"</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-basics_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>For simplicity, we shall show the rest of the examples for just one
model. Any of them could be run on multiple models the same way as shown
above.</p>
<!-- subproblems vs repetition of input data -->
</div>
<div class="section level2">
<h2 id="a-few-basic-additional-arguments-to-nmsim">A few basic additional arguments to <code>NMsim</code><a class="anchor" aria-label="anchor" href="#a-few-basic-additional-arguments-to-nmsim"></a>
</h2>
<p>The first couple of examples were run with the bare minimum of
arguments - estimation control stream and simulation data set. You are
obviously encouraged to read the help of <code>NMsim</code> to learn
about the many useful features it has, and you will learn some more in
this vignette. But there are a few arguments that you should learn about
at this point already. Here they are:</p>
<ul>
<li>
<code>dir.sims</code> Path to a folder in which all generated files
will be stored. Use this to avoid <code>NMsim</code> will write into the
directories where your estimation models are. They may not belong there
at all. You may want to separate the model development step from the
post-processing step. You are encouraged to explore what
<code>NMsim</code> leaves in this directory (you will find fully
reproducible simulation Nonmem runs including simulation input
data).</li>
<li>
<code>dir.res</code> while <code>dir.sims</code> contains all the
Nonmem files, you can specify a separate directory just for compressed
results. The <code>rds</code> files containing information about where
the simulations were performed will also be saved here. This means that
as soon as results have been read once, all contents of
<code>dir.sims</code> can be purged without loss of critical data. This
can save a lot of disk space.</li>
<li>
<code>name.sim</code> Give your simulation a meaningfull name. We
did not do this above, so <code>NMsim</code> called it “noname”.</li>
<li>
<code>table.vars</code> Very important. This redefines the output
table section from the estimation control stream to the simulation
control stream. The estimation control stream may have too many
variables printed (which will make Nonmem slow), or it may not have some
that are useful for the simulation analysis. See how this is used below.
Once you get used to this argument, you will use it very
frequently.</li>
<li>
<code>wait</code> Wait for simulation to be done and return the
resulting data? If not a path to the rds file to be read with
<code>NMreadSim</code> will be returned.</li>
<li>
<code>reuse.results</code> If <code>TRUE</code> and results are
found on file, those will be read instead of rerunning the
simulation.</li>
<li>
<code>seed</code> A numeric value that will be used in Nonmem’s
$SIMULATION section</li>
</ul>
<p>You will learn about a few more arguments in the next examples.</p>
</div>
<div class="section level2">
<h2 id="more-subjects-and-prediction-intervals">More subjects and prediction intervals<a class="anchor" aria-label="anchor" href="#more-subjects-and-prediction-intervals"></a>
</h2>
<p>To create a prediction interval based on the selected model, we need
to simulate multiple new subjects. There are two ways to easily obtain
that. One is to repeat (<code>rbind</code>) the simulation input
dataset, one repetetion per new subject, and then update the
<code>ID</code> column to get distinct subjects.</p>
<div class="section level3">
<h3 id="multiple-subjects-created-in-simulation-input-data">Multiple subjects created in simulation input data<a class="anchor" aria-label="anchor" href="#multiple-subjects-created-in-simulation-input-data"></a>
</h3>
<p>The follwing shows how one could generate 1000 subjects using
<code>data.table</code>. (I use <code>data.table</code> a lot, if you
can provide a good way to do this without, I am happy to include
that).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.sim.1000</span> <span class="op">&lt;-</span> <span class="fu">NMdata</span><span class="fu">::</span><span class="fu"><a href="https://philipdelff.github.io/NMdata/reference/egdt.html" class="external-link">egdt</a></span><span class="op">(</span></span>
<span>                            <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">dat.sim</span><span class="op">)</span><span class="op">[</span>,<span class="op">!</span><span class="op">(</span><span class="st">"ID"</span><span class="op">)</span><span class="op">]</span></span>
<span>                           ,</span>
<span>                            <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ID<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span></span>
<span>                        <span class="op">)</span></span>
<span><span class="va">dat.sim.1000</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">ID</span>,<span class="va">trt</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">## order with respect to new IDs</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dat.sim.1000</span>,<span class="va">trt</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span>
<span><span class="co">## check dataset</span></span>
<span><span class="fu">NMcheckData</span><span class="op">(</span><span class="va">dat.sim.1000</span>,type.data<span class="op">=</span><span class="st">"sim"</span><span class="op">)</span></span></code></pre></div>
<p>We now simulate 1000 subjects by plugging in this data object:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.n1000.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                        data<span class="op">=</span><span class="va">dat.sim.1000</span>,</span>
<span>                        dir.sims<span class="op">=</span><span class="st">"~/NMsim_vignette"</span>, <span class="co">## where to store simulation files</span></span>
<span>                        name.sim<span class="op">=</span><span class="st">"N1000_datarep"</span></span>
<span>                        <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multiple-subjects-generated-by-nonmem">Multiple subjects generated by Nonmem<a class="anchor" aria-label="anchor" href="#multiple-subjects-generated-by-nonmem"></a>
</h3>
<p>The other way to simulate multiple subjects is making use of Nonmem’s
<code>SUBPROBLEMS</code> simulation feature which makes Nonmem rerun the
simulation the specified number of times. Notice that to do this, we use
the <code>dat.sim</code> data without the 1000 replications. We then
make use of the NMREP column generated by
<code><a href="https://philipdelff.github.io/NMdata/reference/NMscanData.html" class="external-link">NMdata::NMscanData</a></code> to redefine the <code>ID</code>
column:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.n1000.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                        data<span class="op">=</span><span class="va">dat.sim</span>,</span>
<span>                        subproblems<span class="op">=</span><span class="fl">1000</span>,</span>
<span>                        dir.sims<span class="op">=</span><span class="st">"~/NMsim_vignette"</span>, <span class="co">## where to save and run Nonmem simulations</span></span>
<span>                        dir.res<span class="op">=</span><span class="st">"simulate-results"</span>, <span class="co">## where to save simulation results</span></span>
<span>                        name.sim<span class="op">=</span><span class="st">"N1000_subproblems"</span>,</span>
<span>                        <span class="op">)</span></span>
<span><span class="va">simres.n1000.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres.n1000.2</span><span class="op">)</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">NMREP</span>,<span class="va">ID</span>,<span class="va">trt</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>The two approaches are computationally about equally fast, the most
significant difference probably being in Nonmem reading a smaller or
larger simulation input data file. Unless the input dataset becomes very
large, it is merely a question of preference of the modeler which one to
use. In a case where the simulated patients need different dosing or
sample schedules, the manual construction of the data is needed -
because it’s not a straightforward replication.</p>
</div>
<div class="section level3">
<h3 id="the-prediction-interval">The prediction interval<a class="anchor" aria-label="anchor" href="#the-prediction-interval"></a>
</h3>
<p>We now plot a prediction interval - in this case based on the results
of the simulation using <code>SUBPROBLEMS</code>; this makes no
difference to how to derive the prediction interval.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.pi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres.n1000.2</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">IPRED</span>,probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span>,<span class="fl">.5</span>,<span class="fl">.95</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,<span class="fu">cc</span><span class="op">(</span><span class="va">ll</span>,<span class="va">median</span>,<span class="va">ul</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                           by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">trt</span>,<span class="va">TIME</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">simres.pi</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"pi"</span></span>
<span><span class="va">simres.pi</span><span class="op">$</span><span class="va">pi.cover</span> <span class="op">&lt;-</span> <span class="st">"90%"</span></span>
<span></span>
<span><span class="va">p.pi.typ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">simres.pi</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,fill<span class="op">=</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">ll</span>,ymax<span class="op">=</span><span class="va">ul</span>,alpha<span class="op">=</span><span class="va">pi.cover</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">median</span>,colour<span class="op">=</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_alpha_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"90%"</span><span class="op">=</span><span class="fl">.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Hours since first dose"</span>,y<span class="op">=</span><span class="st">"Concentration (ng/mL)"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p.pi.typ</span></span></code></pre></div>
<p><img src="NMsim-basics_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="read-previously-generated-simulations">Read previously generated simulations<a class="anchor" aria-label="anchor" href="#read-previously-generated-simulations"></a>
</h2>
<p>There is no need to save simulation results because they are already
saved by <code>NMsim</code>. Instead, use arguments
<code>dir.sims</code>, <code>dir.res</code> and <code>name.sim</code> to
make sure to get a meaningful structure for the generated files. Then
read the results with <code><a href="../reference/NMreadSim.html">NMreadSim()</a></code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.n1000.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="st">"simulate-results/NMsim_xgxr021_N1000_datarep_paths.rds"</span><span class="op">)</span></span></code></pre></div>
<p>In fact, that is also what <code>NMsim</code> does once Nonmem has
run.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>



  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
